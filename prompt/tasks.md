# バグ修正計画 (Tasks for Bug Fixes)

このドキュメントは、`pickit` プロジェクトにおける主要な機能追加とは異なる不具合修正に関する計画を管理します。機能追加については `prompt/plan.md` を参照してください。

各不具合修正は、以下の形式で記述されます。

## 課題/不具合 #[Issue Number] - [簡潔な説明]

-   **説明:** 発生している不具合の具体的な内容、再現手順、および期待される動作。
-   **影響範囲:** 不具合が影響を及ぼすモジュール、機能、またはユーザーエクスペリエンス。
-   **優先度:** (例: 高, 中, 低) - 修正の緊急性。
-   **提案される修正アプローチ:** 不具合を解決するための具体的な方法や検討事項。
-   **ステータス:** (例: 未着手, 調査中, 修正中, レビュー待ち, 完了)

---

### 例: 課題/不具合 #123 - Gitモジュールでの日本語パス処理の不具合

-   **説明:** Gitモジュールが日本語を含むファイルパスを正しく扱えず、ファイルツリーの表示や操作でエラーが発生する。具体的には、`git status` の出力で日本語部分が文字化けしたり、ファイルが見つからないというエラーになる。
-   **影響範囲:** Gitモジュール全般、特にファイルツリー表示、選択、操作に関わる部分。日本語環境のユーザー。
-   **優先度:** 高
-   **提案される修正アプローチ:**
    -   Rustの `std::process::Command` で `git` コマンドを実行する際に、環境変数 `LANG` や `LC_ALL` を `C.UTF-8` または適切なUTF-8ロケールに設定して実行することを検討。
    -   Gitコマンドの出力をUTF-8としてデコードする処理の確認と修正。
    -   OSレベルでのパスエンコーディングの違い（WindowsとLinux/macOS）を考慮したテストの追加。
-   **ステータス:** 未着手

---



### 課題/不具合 #2 - TUI表示色の修正



-   **説明:** Gitのチェックアウト情報が上位にも下位にも存在しないディレクトリ（明示的なチェックアウトがないディレクトリ）が白色で表示されている。本来、これらのディレクトリは間接的にチェックアウトされていない状態を示すために灰色で表示されるべきだが、現在の白色表示ではその状態が正しく伝わらない。結果として、ユーザーが未チェックアウトのディレクトリを識別できなくなっている。

-   **影響範囲:** TUIのUI表示全般、ユーザーエクスペリエンス。

-   **優先度:** 中

-   **提案される修正アプローチ:**
    -   ディレクトリの表示色を決定するロジックを見直す。
    -   特に、ルートノード（最上位ディレクトリ）のチェックアウト状態が、その下位ディレクトリの表示色に与える影響を調査する。
    -   Gitのチェックアウト情報が上位にも下位にも存在しないディレクトリを正しく判定するロジックを実装する。
    -   上記の条件に一致するディレクトリに対して、Ratatuiのスタイルで明示的に灰色（Gray）を指定する。
    -   この状態をテストするためのユニットテストまたは結合テストを追加する。

-   **チェックリスト:**
    -   [x] ディレクトリ表示色のロジックをレビュー
    -   [x] ルートノードのチェックアウト状態が下位に与える影響を調査・特定
    -   [x] 間接的にチェックアウトされていない状態を判定するロジックを実装
    -   [x] 判定ロジックに基づき、対象ディレクトリを灰色で表示するよう修正
    -   [x] 上記の状態を検証するテストケースを追加

-   **ステータス:** 未着手

---

## 課題/不具合 #3 - キー応答遅延の調査と修正

-   **説明:** 大型ディレクトリにおいて、上下キー操作時の応答が著しく遅延し、アプリケーションの利用ストレスが大きい。特にディレクトリ階層が深く、ファイル数が多い場合に顕著である。原因を特定し、応答性能を改善する必要がある。
-   **影響範囲:** TUIのファイルツリー表示、キー操作によるナビゲーション、ユーザーエクスペリエンス全般。
-   **優先度:** 高
-   **提案される修正アプローチ:**
    -   パフォーマンスプロファイリングツールを使用して、キー入力から画面更新までのボトルネックを特定する。
    -   特に、ディレクトリの内容読み込み、ソート、フィルタリング、TUIレンダリングの各フェーズでの処理時間を分析する。
    -   遅延ロード（Lazy Loading）や仮想スクロール（Virtual Scrolling）など、大規模データセットの表示最適化手法の導入を検討する。
    -   キャッシュ機構の導入により、頻繁にアクセスされるディレクトリ情報の再読み込みを削減する。
    -   Git情報の取得が遅延の原因となっている可能性も考慮し、非同期処理やバックグラウンドでの情報更新を検討する。
    -   関連するコード（`src/app.rs`, `src/git.rs` など）のレビューと最適化。
-   **チェックリスト:**
    -   [ ] パフォーマンスプロファイリングの実施とボトルネックの特定
    -   [ ] ディレクトリ内容読み込み、ソート、フィルタリング、TUIレンダリングの処理時間分析
    -   [ ] 遅延ロードまたは仮想スクロールの導入検討
    -   [ ] キャッシュ機構の導入検討
    -   [ ] Git情報取得の非同期化またはバックグラウンド更新の検討
    -   [ ] `src/app.rs`, `src/git.rs` などの関連コードのレビューと最適化
---

## 課題/不具合 #4 - 未ロードノード選択時のチェックアウト漏れ

-   **説明:**
    -   `pickit` アプリケーションでツリーノードを選択し、`a` キーで変更を適用する際、まだ一度も展開されたことがない（＝子ディレクトリ情報がロードされていない）ノードを「チェックアウト対象」（`+`）として選択した場合、そのノードの変更が正しく `git sparse-checkout set` コマンドに反映されず、意図せずチェックアウトから漏れてしまう。
    -   これは、`App::apply_changes` が `self.items` に存在する `pending_change` の状態のみに基づいて変更内容を構築するため、未ロードのノードに関する完全な情報（特に `is_checked_out` の正確な初期状態）が不足していることに起因する。
    -   結果として、ユーザーが視覚的に選択したにも関わらず、Gitリポジリの状態が期待通りに更新されないという問題が発生する。

-   **影響範囲:** 変更適用機能全般、未ロードのツリーノードに対する操作、ユーザーが意図したチェックアウト状態と実際のリポジリ状態の不一致。

-   **優先度:** 高

-   **ステータス:** 完了

---

## 課題/不具合 #10 - 日本語ファイル名対応

-   **説明:** `pickit` は現在、リポジトリの設定に関わらず、日本語ファイル名を正しく扱えていない可能性がある。具体的には、ファイルツリーの表示、`git` コマンドとの連携（`git sparse-checkout` など）、および内部的なパス処理において、日本語文字を含むファイル名やディレクトリ名が文字化けしたり、正しく認識されない可能性がある。これにより、日本語ファイル名を含むプロジェクトでの利用が困難になっている。

-   **影響範囲:** アプリケーション全体のファイルパス処理、特に `src/git.rs` で行われる `git` コマンドの実行と出力解析、およびTUIでの表示。日本語環境のユーザー。

-   **優先度:** 高

-   **提案される修正アプローチ:**
    -   **Gitコマンド実行時のロケール設定の強化:** `std::process::Command` を使用して `git` コマンドを実行する際に、`LANG=C.UTF-8` や `LC_ALL=C.UTF-8` などの環境変数を明示的に設定し、`git` が常にUTF-8エンコーディングで動作するようにする。これにより、`git` の出力が常にUTF-8であることを保証する。
    -   **Git出力のUTF-8デコードの確実化:** `git` コマンドの標準出力および標準エラー出力を、確実にUTF-8としてデコードする処理を実装する。Rustの `String::from_utf8_lossy` や `String::from_utf8` を適切に使用し、無効なUTF-8シーケンスが来た場合のハンドリングを考慮する。
    -   **Path処理のベストプラクティス:** Rustの `Path` および `PathBuf` はOSのネイティブエンコーディングを抽象化しているため、これらを適切に使用する。ただし、`git` コマンドとのやり取りでは文字列（`OsString` -> `String`）への変換が必要となるため、その際のエンコーディングに注意を払う。
    -   **クロスプラットフォーム対応の検討:** Windows環境ではファイルパスのエンコーディングがUTF-8ではない場合がある（特に古いAPIを使用する場合）。`git` は内部的にUTF-8を扱うため、この点での問題は少ないと予想されるが、Rustの `Path` 関連の挙動と合わせて確認する。
    -   **テストケースの追加:** 日本語ファイル名を含むテストリポジトリを作成し、`pickit` がこれらのファイル名を正しく表示し、操作できることを検証するユニットテストおよび結合テストを追加する。特に、`git sparse-checkout` コマンドが日本語パスを正しく処理するかを確認する。

-   **ステータス:** 未着手
