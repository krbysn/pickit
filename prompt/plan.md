# pickit 実行計画 (3層アーキテクチャ版)

この計画は、`pickit` の実装を複数のPull Request (PR) に分割し、段階的に開発を進めるためのロードマップです。UI層とアプリケーション層を分離するアーキテクチャを採用します。

---

### **PR #1: プロジェクト基盤の構築とGit連携モジュールの作成**
**目的:** プロジェクトの初期設定と、Gitリポジリ情報を取得するための基本的な機能を実装する。(変更なし)
- **タスク:**
    1. `cargo new pickit` でプロジェクトを作成。
    2. `ratatui`, `clap`, `thiserror` などの基本ライブラリを `Cargo.toml` に追加。
    3. `git` モジュールを作成。
    4. リポジリのルートディレクトリを検出する関数を実装 (`git rev-parse --show-toplevel`)。
    5. `cone` モードでチェックアウトされているディレクトリ一覧を取得する関数を実装 (`git sparse-checkout list`)。
    6. リポジリ内の全ディレクトリ一覧を取得する関数を実装 (`git ls-tree -r --name-only -d HEAD`)。
    7. 上記関数に対するユニットテストを作成。

---

### **PR #2: TUIとApp層の骨格構築**
**目的:** TUIの基本的な骨格を構築し、**単体のアプリケーションとして起動して、静的なディレクトリ一覧を表示できる状態にする。**
- **タスク:**
    1. UIから分離された `app` モジュールを作成し、アプリケーションの状態を保持する `App` 構造体を定義。
    2. `App` 構造体に、Gitモジュールを使ってディレクトリツリー情報を読み込む初期化処理を実装。
    3. `main.rs` にTUIの初期化・終了処理、メインループを実装。
    4. `ratatui` を使い、画面を3パネル（ツリー、グリッド、フッター）に分割。
    5. `App` インスタンスから取得したデータを、加工せずに「ツリービュー」に単純なリストとして描画する。
    6. `cargo run` で起動し、UIが表示されることを確認する。

---

### **PR #3: App層のビジネスロジック実装とテスト**
**目的:** アプリケーションのコアとなるビジネスロジックを `App` 層に実装し、ユニットテストで品質を保証する。**このPRではTUIの見た目はほぼ変更しない。**
- **タスク:**
    1. `App` 構造体に、ツリーの状態（カーソル位置、展開状態、変更待ちフラグ）を管理するフィールドを追加。
    2. ユーザー操作を抽象化したメソッドを実装 (`move_cursor`, `toggle_expansion`, `toggle_selection`)。
    3. 選択されたディレクトリの未コミットの変更をチェックし、ロック状態を判定するロジックを実装。
    4. 上記の各ロジックに対するユニットテストを網羅的に作成する。

---

### **PR #4: TUIとApp層の連携（インタラクティブ化）**
**目的:** TUIのイベントを `App` 層に伝え、その結果をUIに反映させることで、アプリケーションを対話的に操作できるようにする。
- **タスク:**
    1. TUIのメインループで、キー入力を `App` のメソッド呼び出しに変換する（例: `KeyCode::Down` -> `app.move_cursor()`)。
    2. `App` 層に、TUIが必要とする情報（描画用のシンボルや色など）をまとめたViewModelを返すゲッターを実装。
    3. ゲッターから取得したViewModelを元に、ツリービューを状態に合わせて描画する（記号、色、展開状態など）。
    4. これでツリービューが完全にインタラクティブになる。

---

### **PR #5: グリッドビューの実装**
**目的:** `App` 層の情報を利用して、グリッドビューを完成させる。
- **タスク:**
    1. `App` 層に、グリッドビュー用の詳細なViewModelを返すゲッターを実装する。
    2. ツリービューでのカーソル移動に追従し、`App` から取得したViewModelを元にグリッドビューを描画する。

---

### **PR #6: 変更適用機能の実装**
**目的:** ユーザーが選択した変更を `git sparse-checkout` コマンドで実際に適用する機能を完成させる。
- **タスク:**
    1. `App` 層に、適用すべき変更内容から `git sparse-checkout set` コマンドを生成し、実行するメソッド (`apply_changes`) を実装。
    2. TUIで `a` (Apply) キーが押されたら、確認プロンプトを表示後、`app.apply_changes()` を呼び出す。
    3. `App` 層でコマンド実行と、その後の状態リフレッシュ処理を行う。
    4. Gitコマンドのエラーは `App` 層でハンドリングし、TUIは受け取ったエラーメッセージを表示する。

---

### **PR #7: 仕上げとCLI引数の対応**
**目的:** アプリケーションを完成させ、ユーザビリティを向上させる。(旧PR#6)
- **タスク:**
    1. `clap` を用いて、`pickit <path>` のようにリポジトリパスを引数で受け取れるようにする。
    2. フッターに表示するキーバインドやヘルプテキストを充実させる。
    3. アプリケーション全体の動作を見直し、細かいUI/UXの調整を行う。
    4. プロジェクトの `README.md` を作成する。

## 機能追加計画

### PR8: 外部リポジトリ変更の自動検知 (ファイルシステム監視)

**目的:**
アプリケーション実行中に、外部のプロセス（別のターミナルなど）によって Git リポジリの状態が変更された場合、その変更を TUI に自動的に反映させ、常に最新の状態を表示するようにする。

**実装計画:**
- **アプローチ:** `.git` ディレクトリ内の特定ファイルを監視する手法を採用する。これは、定期的に `git` コマンドをポーリングするよりも効率的で、リアルタイム性に優れているため。
- **ライブラリの導入:** クロスプラットフォーム（Linux, macOS, Windows）で動作するファイルシステム監視ライブラリ `notify` を `Cargo.toml` に追加する。
- **監視の実装:**
    1. アプリケーション起動時に、ワーカースレッドを一つ生成する。
    2. ワーカースレッド内で `notify` を設定し、以下のファイル/ディレクトリの変更監視を開始する:
        - `.git/HEAD`: ブランチの切り替えを検知。
        - `.git/index`: ステージングエリアの変更（`git add` など）を検知。
        - `.git/info/sparse-checkout`: `sparse-checkout` 設定の外部変更を検知。
        - `.git/refs/heads/`: 各ブランチのコミット更新を検知。
    3. ファイル変更イベントを検知したら、メインスレッドに通知を送る（例: `mpsc` チャンネルを使用）。
- **状態の更新:**
    1. メインのイベントループ (`run_app`) は、キーボード入力と並行して、ワーカースレッドからの通知をノンブロッキングで待つ。
    2. 通知を受け取ったら、`app.refresh()` メソッドを呼び出し、リポジリの状態を再読み込みして TUI 全体を再描画する。
    3. パフォーマンスへの影響を避けるため、短時間に連続してイベントが発生した場合はデバウンス処理（例: 一定時間内のイベントを一度にまとめる）を検討する。

---

### **PR #9: 変更適用時のプログレスダイアログ表示**
**目的:** 変更適用時にアプリケーションが一時的に停止しているように見える問題を解消し、ユーザーに進捗状況を視覚的に伝える。
- **タスク:**
    1. `App` 構造体に、変更適用中であることを示す`is_applying_changes: bool`フラグを追加。
    2. `App::apply_changes` メソッド内で、処理開始時に `is_applying_changes` を `true` に設定し、処理完了後（成功・失敗問わず）に `false` に戻す。
    3. `run_app` 関数（TUIレンダリングループ）内で、`app.is_applying_changes` が `true` の場合、メインUIの代わりに「変更を適用中...お待ちください。」というメッセージを表示するシンプルなプログレスダイアログをレンダリングする。
    4. `is_applying_changes` フラグのライフサイクルを検証するユニットテストを追加。