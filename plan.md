# pickit 実行計画

このドキュメントは、`pickit` の開発計画と進捗を記録します。

---

## パフォーマンス改善計画

### Step 1: Git Status チェックの最適化 (完了)

**問題点:**
`app::refresh` 処理において、リポジトリ内の全ディレクトリに対して `git status` コマンドを個別に実行しており、大規模リポジトリで著しいパフォーマンス低下を引き起こしていました。

**改善内容:**
-   `git.rs` を修正し、`git status --porcelain=v1` を一度だけ呼び出してリポジトリ全体の変更状態を取得する `get_uncommitted_paths` 関数を実装しました。
-   `app.rs` の `refresh` 関数を修正し、`get_uncommitted_paths` から得た変更リストをメモリ上でチェックするようにロジックを変更しました。
-   これにより、`git` プロセスの呼び出し回数がディレクトリ数から1回に削減され、初期化時間が大幅に短縮されました。
-   この変更はコミット `12ee8f7` (`perf: Optimize git status check`) で `main` ブランチにマージ済みです。

### Step 2: ファイル一覧取得の高速化 (今後の計画)

**問題点:**
現在の `git::get_all_dirs` 関数は、`git ls-tree` コマンドを実行してディレクトリ一覧を取得しています。これは `git` プロセスを呼び出すため、依然としてオーバーヘッドが存在します。

**改善計画:**
-   `git ls-tree` の呼び出しを、Rust の高速なファイルシステムウォークライブラリである `jwalk` と `ignore` に置き換えます。
-   `jwalk::WalkBuilder` を使用して、マルチスレッドでディレクトリ構造を並列にスキャンします。
-   `ignore` クレートと連携し、`.gitignore` ファイルのルールを適用して、Git が無視するファイルを走査対象から除外します。
-   これにより、`git` プロセスの呼び出しを完全に排除し、さらなる初期化時間の短縮を目指します。

## 機能追加計画

### PR8: 外部リポジトリ変更の自動検知 (ファイルシステム監視)

**目的:**
アプリケーション実行中に、外部のプロセス（別のターミナルなど）によって Git リポジトリの状態が変更された場合、その変更を TUI に自動的に反映させ、常に最新の状態を表示するようにする。

**実装計画:**
- **アプローチ:** `.git` ディレクトリ内の特定ファイルを監視する手法を採用する。これは、定期的に `git` コマンドをポーリングするよりも効率的で、リアルタイム性に優れているため。
- **ライブラリの導入:** クロスプラットフォーム（Linux, macOS, Windows）で動作するファイルシステム監視ライブラリ `notify` を `Cargo.toml` に追加する。
- **監視の実装:**
    1. アプリケーション起動時に、ワーカースレッドを一つ生成する。
    2. ワーカースレッド内で `notify` を設定し、以下のファイル/ディレクトリの変更監視を開始する:
        - `.git/HEAD`: ブランチの切り替えを検知。
        - `.git/index`: ステージングエリアの変更（`git add` など）を検知。
        - `.git/info/sparse-checkout`: `sparse-checkout` 設定の外部変更を検知。
        - `.git/refs/heads/`: 各ブランチのコミット更新を検知。
    3. ファイル変更イベントを検知したら、メインスレッドに通知を送る（例: `mpsc` チャンネルを使用）。
- **状態の更新:**
    1. メインのイベントループ (`run_app`) は、キーボード入力と並行して、ワーカースレッドからの通知をノンブロッキングで待つ。
    2. 通知を受け取ったら、`app.refresh()` メソッドを呼び出し、リポジトリの状態を再読み込みして TUI 全体を再描画する。
    3. パフォーマンスへの影響を避けるため、短時間に連続してイベントが発生した場合はデバウンス処理（例: 一定時間内のイベントを一度にまとめる）を検討する。